import pytest
import jira
from unittest.mock import MagicMock, patch
import json

jira = jira.Jira(" ", " ", " ")

@patch('jira.requests')
@pytest.mark.parametrize('http_code , expected_response', [
    (200, "My connection to Jira is up and running!"),
    (500, "Looks like there's an issue with my connection. I've logged an error")
])
def test_testConnectionCommand(mock_requests, http_code, expected_response):
    mock_requests.request.return_value = MagicMock(status_code=http_code, text='{"text": "some mock test"}')

    response = jira.testConnectionCommand("")

    assert response == expected_response

def test_getCommandsRegex():
    expected_response = {
        'test jira': jira.testConnectionCommand,
        'sprint metrics [0-9]+': jira.getSprintMetricsCommand
    }

    assert jira.getCommandsRegex() == expected_response

def test_getCommandDescriptions():
    expected_response = {
        'test jira': 'tests my connection to jira',
        'sprint metrics [sprint-id]': 'get metrics for a given sprint'
    }

    assert jira.getCommandDescriptions() == expected_response

# Test Data
valid_response = json.dumps({
    "issue_keys": {
    "committed": [
        "MADD-244",
        "MADD-252",
        "MADD-279",
        "MADD-282",
        "MADD-284",
        "MADD-242",
        "MADD-278"
    ],
    "completed": [
    "MADD-244",
    "MADD-252",
    "MADD-253",
    "MADD-279",
    "MADD-282",
    "MADD-284",
    "MADD-286",
    "MADD-287",
    "MADD-290",
    "MADD-291",
        "MADD-294"
    ],
    "incomplete": [
        "MADD-242",
        "MADD-278"
    ],
    "removed": []
    },
    "items": {
        "bugs_completed": 1,
        "committed": 7,
        "completed": 7,
        "not_completed": 2,
        "planned_completed": 5,
        "removed": 0,
        "stories_completed": 6,
        "unplanned_bugs_completed": 1,
        "unplanned_completed": 2,
        "unplanned_stories_completed": 1
    },
    "points": {
        "committed": 23,
        "completed": 16,
        "feature_completed": 16,
        "not_completed": 8,
        "optimization_completed": 0,
        "planned_completed": 15,
        "removed": 0,
        "unplanned_completed": 1
    }
}, sort_keys=True, indent=4, separators=(",", ": "))
valid_response = f"```{valid_response}```"

sprint_id = '1234'
board_id = '4321'
error_response = "Sorry, I had trouble getting metrics for that sprint. I've logged an error"

valid_sprint_response = {'status_code': 200, 'text': json.dumps({'id': 4359, 'self': 'https://thetower.atlassian.net/rest/agile/1.0/sprint/4359', 'state': 'closed', 'name': 'DD Sprint 2 (2/18 - 3/2)', 'startDate': '2020-02-19T13:09:38.038Z', 'endDate': '2020-03-02T13:09:38.000Z', 'completeDate': '2020-03-02T19:06:41.941Z', 'originBoardId': 651, 'goal': '- Continue working on Key Automation\n- Complete OneTrust Change\n- Make Cardinal Change ahead of March 4th Deadline'})}
valid_report_response = {'status_code': 200, 'text': json.dumps({'contents': {'completedIssues': [{'id': 267728, 'key': 'MADD-244', 'hidden': False, 'typeName': 'Story', 'typeId': '7', 'summary': '(2) Key Position Config at Pub Level: Year field auto pop', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12615&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': False, 'assignee': 'gwilhelm', 'assigneeKey': 'gwilhelm', 'assigneeAccountId': '557058:3f5f4feb-5bd4-4744-9923-0a935b56c0cc', 'assigneeName': 'Greg Wilhelm', 'avatarUrl': 'https://secure.gravatar.com/avatar/fd5b3059fc4ce8e137703b0243a7963c?d=https%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FGW-6.png&size=48&s=48', 'hasCustomUserAvatar': False, 'flagged': False, 'epic': 'MADD-295', 'epicField': {'id': 'customfield_10009', 'label': 'Epic', 'editable': False, 'renderer': 'epiclink', 'epicKey': 'MADD-295', 'canRemoveEpic': False}, 'currentEstimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 5.0}}, 'estimateStatisticRequired': False, 'estimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 5.0}}, 'statusId': '10522', 'statusName': 'Verified in Staging', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'status': {'id': '10522', 'name': 'Verified in Staging', 'description': 'Ticket has been verified in staging and is ready for a prod build', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'statusCategory': {'id': '4', 'key': 'indeterminate', 'colorName': 'yellow'}}, 'fixVersions': [45948], 'projectId': 23619, 'linkedPagesCount': 0}, {'id': 267770, 'key': 'MADD-252', 'hidden': False, 'typeName': 'Story', 'typeId': '7', 'summary': 'Key Position Config at Pub Level: Month Field Auto-Pop', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12615&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': False, 'assignee': 'gwilhelm', 'assigneeKey': 'gwilhelm', 'assigneeAccountId': '557058:3f5f4feb-5bd4-4744-9923-0a935b56c0cc', 'assigneeName': 'Greg Wilhelm', 'avatarUrl': 'https://secure.gravatar.com/avatar/fd5b3059fc4ce8e137703b0243a7963c?d=https%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FGW-6.png&size=48&s=48', 'hasCustomUserAvatar': False, 'flagged': False, 'epic': 'MADD-295', 'epicField': {'id': 'customfield_10009', 'label': 'Epic', 'editable': False, 'renderer': 'epiclink', 'epicKey': 'MADD-295', 'canRemoveEpic': False}, 'currentEstimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 3.0}}, 'estimateStatisticRequired': False, 'estimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 3.0}}, 'statusId': '10522', 'statusName': 'Verified in Staging', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'status': {'id': '10522', 'name': 'Verified in Staging', 'description': 'Ticket has been verified in staging and is ready for a prod build', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'statusCategory': {'id': '4', 'key': 'indeterminate', 'colorName': 'yellow'}}, 'fixVersions': [45948], 'projectId': 23619, 'linkedPagesCount': 0}, {'id': 267772, 'key': 'MADD-253', 'hidden': False, 'typeName': 'Story', 'typeId': '7', 'summary': 'Key Position Config at Pub Level: Move Publisher Level Feature to Production', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12615&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': False, 'assignee': 'MVanRiessen', 'assigneeKey': 'mvanriessen', 'assigneeAccountId': '557058:f5ef3435-01b2-4b72-b9da-f6b37160a0ea', 'assigneeName': 'Mark Van Riessen', 'avatarUrl': 'https://secure.gravatar.com/avatar/ebfb9f020dbcd02f8edfab16ddb1ae11?d=https%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FMR-0.png&size=48&s=48', 'hasCustomUserAvatar': False, 'flagged': False, 'epic': 'MADD-295', 'epicField': {'id': 'customfield_10009', 'label': 'Epic', 'editable': False, 'renderer': 'epiclink', 'epicKey': 'MADD-295', 'canRemoveEpic': False}, 'currentEstimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 1.0}}, 'estimateStatisticRequired': False, 'estimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 1.0}}, 'statusId': '10522', 'statusName': 'Verified in Staging', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'status': {'id': '10522', 'name': 'Verified in Staging', 'description': 'Ticket has been verified in staging and is ready for a prod build', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'statusCategory': {'id': '4', 'key': 'indeterminate', 'colorName': 'yellow'}}, 'fixVersions': [], 'projectId': 23619, 'linkedPagesCount': 0}, {'id': 269178, 'key': 'MADD-279', 'hidden': False, 'typeName': 'Story', 'typeId': '7', 'summary': '(1) New confirmation tag for eHub transaction ID', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12615&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': False, 'assignee': 'POwens', 'assigneeKey': 'powens', 'assigneeAccountId': '557058:95e4decc-7d36-4028-8f9a-f5cab943593e', 'assigneeName': 'Patrick Owens', 'avatarUrl': 'https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:95e4decc-7d36-4028-8f9a-f5cab943593e/cb7071e2-a894-4b10-97e3-65e86e5c757e/128?size=48&s=48', 'hasCustomUserAvatar': False, 'flagged': False, 'currentEstimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 2.0}}, 'estimateStatisticRequired': False, 'estimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 2.0}}, 'statusId': '6', 'statusName': 'Closed', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/closed.png', 'status': {'id': '6', 'name': 'Closed', 'description': '', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/closed.png', 'statusCategory': {'id': '3', 'key': 'done', 'colorName': 'green'}}, 'fixVersions': [], 'projectId': 23619, 'linkedPagesCount': 0}, {'id': 269618, 'key': 'MADD-282', 'hidden': False, 'typeName': 'Story', 'typeId': '7', 'summary': 'On/off switch for the auto key creation at a page level', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12615&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': False, 'assignee': 'POwens', 'assigneeKey': 'powens', 'assigneeAccountId': '557058:95e4decc-7d36-4028-8f9a-f5cab943593e', 'assigneeName': 'Patrick Owens', 'avatarUrl': 'https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:95e4decc-7d36-4028-8f9a-f5cab943593e/cb7071e2-a894-4b10-97e3-65e86e5c757e/128?size=48&s=48', 'hasCustomUserAvatar': False, 'flagged': False, 'epic': 'MADD-295', 'epicField': {'id': 'customfield_10009', 'label': 'Epic', 'editable': False, 'renderer': 'epiclink', 'epicKey': 'MADD-295', 'canRemoveEpic': False}, 'currentEstimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 2.0}}, 'estimateStatisticRequired': False, 'estimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 2.0}}, 'statusId': '10522', 'statusName': 'Verified in Staging', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'status': {'id': '10522', 'name': 'Verified in Staging', 'description': 'Ticket has been verified in staging and is ready for a prod build', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'statusCategory': {'id': '4', 'key': 'indeterminate', 'colorName': 'yellow'}}, 'fixVersions': [45948], 'projectId': 23619, 'linkedPagesCount': 0}, {'id': 269848, 'key': 'MADD-284', 'hidden': False, 'typeName': 'Story', 'typeId': '7', 'summary': 'Updating calls with Cardinal Commerce from GET to POST', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12615&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': False, 'assignee': 'MVanRiessen', 'assigneeKey': 'mvanriessen', 'assigneeAccountId': '557058:f5ef3435-01b2-4b72-b9da-f6b37160a0ea', 'assigneeName': 'Mark Van Riessen', 'avatarUrl': 'https://secure.gravatar.com/avatar/ebfb9f020dbcd02f8edfab16ddb1ae11?d=https%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FMR-0.png&size=48&s=48', 'hasCustomUserAvatar': False, 'flagged': False, 'currentEstimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 3.0}}, 'estimateStatisticRequired': False, 'estimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 3.0}}, 'statusId': '10522', 'statusName': 'Verified in Staging', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'status': {'id': '10522', 'name': 'Verified in Staging', 'description': 'Ticket has been verified in staging and is ready for a prod build', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'statusCategory': {'id': '4', 'key': 'indeterminate', 'colorName': 'yellow'}}, 'fixVersions': [45948], 'projectId': 23619, 'linkedPagesCount': 0}, {'id': 270608, 'key': 'MADD-286', 'hidden': False, 'typeName': 'Task', 'typeId': '3', 'summary': 'Lisa: Pre-Grooming', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12618&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': True, 'assignee': 'ljohnson', 'assigneeKey': 'ljohnson', 'assigneeAccountId': '557058:146ceabe-26d1-4336-9e8b-0703c2673245', 'assigneeName': 'Lisa Johnson', 'avatarUrl': 'https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:146ceabe-26d1-4336-9e8b-0703c2673245/5979d7fa-956b-4cc5-b595-be90fff5ec46/128?size=48&s=48', 'hasCustomUserAvatar': False, 'flagged': False, 'currentEstimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {}}, 'estimateStatisticRequired': False, 'estimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {}}, 'statusId': '6', 'statusName': 'Closed', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/closed.png', 'status': {'id': '6', 'name': 'Closed', 'description': '', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/closed.png', 'statusCategory': {'id': '3', 'key': 'done', 'colorName': 'green'}}, 'fixVersions': [], 'projectId': 23619, 'linkedPagesCount': 0}, {'id': 270609, 'key': 'MADD-287', 'hidden': False, 'typeName': 'Task', 'typeId': '3', 'summary': 'Pat: Pre-Grooming', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12618&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': True, 'assignee': 'POwens', 'assigneeKey': 'powens', 'assigneeAccountId': '557058:95e4decc-7d36-4028-8f9a-f5cab943593e', 'assigneeName': 'Patrick Owens', 'avatarUrl': 'https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:95e4decc-7d36-4028-8f9a-f5cab943593e/cb7071e2-a894-4b10-97e3-65e86e5c757e/128?size=48&s=48', 'hasCustomUserAvatar': False, 'flagged': False, 'currentEstimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {}}, 'estimateStatisticRequired': False, 'estimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {}}, 'statusId': '6', 'statusName': 'Closed', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/closed.png', 'status': {'id': '6', 'name': 'Closed', 'description': '', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/closed.png', 'statusCategory': {'id': '3', 'key': 'done', 'colorName': 'green'}}, 'fixVersions': [], 'projectId': 23619, 'linkedPagesCount': 0}, {'id': 270612, 'key': 'MADD-290', 'hidden': False, 'typeName': 'Task', 'typeId': '3', 'summary': 'Greg: Pre-Grooming', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12618&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': True, 'hasCustomUserAvatar': False, 'flagged': False, 'currentEstimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {}}, 'estimateStatisticRequired': False, 'estimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {}}, 'statusId': '6', 'statusName': 'Closed', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/closed.png', 'status': {'id': '6', 'name': 'Closed', 'description': '', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/closed.png', 'statusCategory': {'id': '3', 'key': 'done', 'colorName': 'green'}}, 'fixVersions': [], 'projectId': 23619, 'linkedPagesCount': 0}, {'id': 270825, 'key': 'MADD-291', 'hidden': False, 'typeName': 'Bug', 'typeId': '1', 'summary': 'Failed OneTrust calls should give a severe error in the cron job email', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12603&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': False, 'assignee': 'gwilhelm', 'assigneeKey': 'gwilhelm', 'assigneeAccountId': '557058:3f5f4feb-5bd4-4744-9923-0a935b56c0cc', 'assigneeName': 'Greg Wilhelm', 'avatarUrl': 'https://secure.gravatar.com/avatar/fd5b3059fc4ce8e137703b0243a7963c?d=https%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FGW-6.png&size=48&s=48', 'hasCustomUserAvatar': False, 'flagged': False, 'estimateStatisticRequired': False, 'statusId': '10522', 'statusName': 'Verified in Staging', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'status': {'id': '10522', 'name': 'Verified in Staging', 'description': 'Ticket has been verified in staging and is ready for a prod build', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'statusCategory': {'id': '4', 'key': 'indeterminate', 'colorName': 'yellow'}}, 'fixVersions': [], 'projectId': 23619, 'linkedPagesCount': 0}, {'id': 271133, 'key': 'MADD-294', 'hidden': False, 'typeName': 'Task', 'typeId': '3', 'summary': 'Ryan: Pre-Grooming', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12618&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': True, 'assignee': 'ryan.owens', 'assigneeKey': 'ryan.owens', 'assigneeAccountId': '5cdda212254e450fd8d225cb', 'assigneeName': 'Ryan Owens', 'avatarUrl': 'https://secure.gravatar.com/avatar/bbedaa9dc299f1238dcf02f107d6ffb7?d=https%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FRO-6.png&size=48&s=48', 'hasCustomUserAvatar': False, 'flagged': False, 'currentEstimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {}}, 'estimateStatisticRequired': False, 'estimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {}}, 'statusId': '6', 'statusName': 'Closed', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/closed.png', 'status': {'id': '6', 'name': 'Closed', 'description': '', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/closed.png', 'statusCategory': {'id': '3', 'key': 'done', 'colorName': 'green'}}, 'fixVersions': [], 'projectId': 23619, 'linkedPagesCount': 0}], 'issuesNotCompletedInCurrentSprint': [{'id': 267726, 'key': 'MADD-242', 'hidden': False, 'typeName': 'Story', 'typeId': '7', 'summary': '(1) Key Position Config at Pub Level: For drop down type allow default to be selected', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12615&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': False, 'assignee': 'gwilhelm', 'assigneeKey': 'gwilhelm', 'assigneeAccountId': '557058:3f5f4feb-5bd4-4744-9923-0a935b56c0cc', 'assigneeName': 'Greg Wilhelm', 'avatarUrl': 'https://secure.gravatar.com/avatar/fd5b3059fc4ce8e137703b0243a7963c?d=https%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FGW-6.png&size=48&s=48', 'hasCustomUserAvatar': False, 'flagged': False, 'epic': 'MADD-295', 'epicField': {'id': 'customfield_10009', 'label': 'Epic', 'editable': False, 'renderer': 'epiclink', 'epicKey': 'MADD-295', 'canRemoveEpic': False}, 'currentEstimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 5.0}}, 'estimateStatisticRequired': False, 'estimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 5.0}}, 'statusId': '10723', 'statusName': 'Feature Review', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'status': {'id': '10723', 'name': 'Feature Review', 'description': 'Feature Review', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'statusCategory': {'id': '4', 'key': 'indeterminate', 'colorName': 'yellow'}}, 'fixVersions': [], 'projectId': 23619, 'linkedPagesCount': 0}, {'id': 268866, 'key': 'MADD-278', 'hidden': False, 'typeName': 'Story', 'typeId': '7', 'summary': '(X) Update to OneTrust cron job -  Store and send multiple mag codes', 'typeUrl': 'https://thetower.atlassian.net/secure/viewavatar?size=medium&avatarId=12615&avatarType=issuetype', 'priorityUrl': 'https://thetower.atlassian.net/images/icons/priorities/trivial.svg', 'priorityName': 'Unknown', 'done': False, 'assignee': 'POwens', 'assigneeKey': 'powens', 'assigneeAccountId': '557058:95e4decc-7d36-4028-8f9a-f5cab943593e', 'assigneeName': 'Patrick Owens', 'avatarUrl': 'https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:95e4decc-7d36-4028-8f9a-f5cab943593e/cb7071e2-a894-4b10-97e3-65e86e5c757e/128?size=48&s=48', 'hasCustomUserAvatar': False, 'flagged': False, 'currentEstimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 3.0}}, 'estimateStatisticRequired': False, 'estimateStatistic': {'statFieldId': 'customfield_10004', 'statFieldValue': {'value': 3.0}}, 'statusId': '10723', 'statusName': 'Feature Review', 'statusUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'status': {'id': '10723', 'name': 'Feature Review', 'description': 'Feature Review', 'iconUrl': 'https://thetower.atlassian.net/images/icons/statuses/generic.png', 'statusCategory': {'id': '4', 'key': 'indeterminate', 'colorName': 'yellow'}}, 'fixVersions': [], 'projectId': 23619, 'linkedPagesCount': 0}], 'puntedIssues': [], 'issuesCompletedInAnotherSprint': [], 'completedIssuesInitialEstimateSum': {'value': 16.0, 'text': '16.0'}, 'completedIssuesEstimateSum': {'value': 16.0, 'text': '16.0'}, 'issuesNotCompletedInitialEstimateSum': {'value': 8.0, 'text': '8.0'}, 'issuesNotCompletedEstimateSum': {'value': 8.0, 'text': '8.0'}, 'allIssuesEstimateSum': {'value': 25.0, 'text': '25.0'}, 'puntedIssuesInitialEstimateSum': {'text': 'null'}, 'puntedIssuesEstimateSum': {'text': 'null'}, 'issuesCompletedInAnotherSprintInitialEstimateSum': {'text': 'null'}, 'issuesCompletedInAnotherSprintEstimateSum': {'text': 'null'}, 'issueKeysAddedDuringSprint': {'MADD-294': True, 'MADD-253': True, 'MADD-291': True}}, 'sprint': {'id': 4359, 'sequence': 4359, 'name': 'DD Sprint 2 (2/18 - 3/2)', 'state': 'CLOSED', 'linkedPagesCount': 0, 'goal': '- Continue working on Key Automation\n- Complete OneTrust Change\n- Make Cardinal Change ahead of March 4th Deadline', 'startDate': '19/Feb/20 8:09 AM', 'endDate': '02/Mar/20 8:09 AM', 'isoStartDate': '2020-02-19T08:09:38-0500', 'isoEndDate': '2020-03-02T08:09:38-0500', 'completeDate': '02/Mar/20 2:06 PM', 'isoCompleteDate': '2020-03-02T14:06:41-0500', 'canUpdateSprint': True, 'remoteLinks': [], 'daysRemaining': 0}, 'lastUserToClose': '<a class="user-hover" rel="5d6e694495fbcc0c341d87e8" id="_5d6e694495fbcc0c341d87e8" data-user="{&quot;accountId&quot;: &quot;5d6e694495fbcc0c341d87e8&quot;}" href="/secure/ViewProfile.jspa?accountId=5d6e694495fbcc0c341d87e8">Chris Gamio</a>', 'supportsPages': True})}

@patch('jira.requests')
@pytest.mark.parametrize('message, sprint_get_response, report_get_response,  expected_response', [
    ('sprint metrics 1234', {'status_code': 500, 'text': 'No Sprint Found!'}, {}, error_response),
    ('sprint metrics 1234', {}, {'status_code': 500, 'text': 'No Board Found!'}, error_response),
    ('sprint metrics 1234', valid_sprint_response, valid_report_response, valid_response),
])
def test_getSprintMetricsCommand(mock_requests, message, sprint_get_response, report_get_response, expected_response):

    def request_side_effect(verb, url, *args, **kwargs):
        if 'sprint/' in url:
            return MagicMock(**sprint_get_response)
        if 'rapid/charts/sprintreport' in url:
            return MagicMock(**report_get_response)

    mock_requests.request.side_effect = request_side_effect

    assert jira.getSprintMetricsCommand(message) == expected_response
